<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scholastic Rocket League – Championship Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0b0f19;
      --panel: #141b2d;
      --rl-blue: #009dff;
      --rl-orange: #ff8d00;
      --text-main: #ece8e1;
      --text-muted: #6f7b9b;
      --border: rgba(0, 157, 255, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Rajdhani', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    /* --- BACKGROUND GRID --- */
    .bg-grid {
      position: fixed;
      top: 0; left: 0; width: 200%; height: 200%;
      background-image: 
        linear-gradient(rgba(0, 157, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 157, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: -1;
      animation: gridMove 40s linear infinite;
      pointer-events: none;
    }

    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(-50px, -50px); }
    }

    /* --- HEADER --- */
    .header-block {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 2.2rem;
      margin: 0;
      letter-spacing: 1px;
      line-height: 1;
      color: var(--text-main);
      text-shadow: 0 0 20px rgba(0, 157, 255, 0.4);
    }

    .sub-h1 {
      font-family: 'Share Tech Mono', monospace;
      color: var(--rl-orange);
      font-size: 0.9rem;
      margin-top: 4px;
      letter-spacing: 1px;
    }

    .live-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.8rem;
      color: var(--rl-blue);
      background: rgba(0, 157, 255, 0.05);
      padding: 6px 16px;
      border: 1px solid rgba(0, 157, 255, 0.3);
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }

    .pulse-dot {
      width: 8px; height: 8px;
      background: var(--rl-blue);
      border-radius: 50%;
      animation: pulseBlue 2s infinite;
    }

    @keyframes pulseBlue {
      0% { box-shadow: 0 0 0 0 rgba(0, 157, 255, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(0, 157, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 157, 255, 0); }
    }

    /* --- LAYOUT --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 350px 1fr 350px; /* Standings | Matches | Finals */
      gap: 20px;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
    }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(20, 27, 45, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Tech Corners */
    .panel::before {
      content: ""; position: absolute; top: -1px; left: -1px;
      width: 15px; height: 15px;
      border-top: 2px solid var(--rl-blue);
      border-left: 2px solid var(--rl-blue);
    }
    .panel::after {
      content: ""; position: absolute; bottom: -1px; right: -1px;
      width: 15px; height: 15px;
      border-bottom: 2px solid var(--rl-orange);
      border-right: 2px solid var(--rl-orange);
    }

    .panel-title {
      font-size: 1.1rem;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--rl-blue);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
      margin-bottom: 5px;
      letter-spacing: 1px;
    }

    /* --- STANDINGS BOARD --- */
    .standings-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 4px;
      font-size: 0.9rem;
    }
    
    .standings-table th {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      font-family: 'Share Tech Mono';
      text-transform: uppercase;
      padding-bottom: 8px;
    }
    .standings-table th:first-child { text-align: left; }

    .standings-row {
      background: #1e273b;
      transition: all 0.3s ease;
    }
    
    .standings-row td {
      padding: 10px 8px;
      text-align: center;
      border-top: 1px solid transparent;
      border-bottom: 1px solid transparent;
    }
    .standings-row td:first-child {
      text-align: left;
      font-weight: 700;
      padding-left: 12px;
      border-left: 3px solid transparent;
    }

    /* Top 2 Qualification Highlight */
    .standings-row.qualified {
      background: linear-gradient(90deg, rgba(0, 157, 255, 0.15), rgba(20, 27, 45, 0));
    }
    .standings-row.qualified td:first-child {
      border-left: 3px solid var(--rl-blue);
      color: #fff;
      text-shadow: 0 0 10px var(--rl-blue);
    }

    .stat-num { font-family: 'Share Tech Mono'; color: #cbd5e1; }
    .stat-diff { font-weight: bold; }
    .pos { color: var(--rl-orange); }
    .neg { color: #f87171; }

    /* --- MATCH LIST --- */
    .matches-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .match-card {
      background: #1b2333;
      padding: 12px;
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%);
      border-left: 2px solid transparent;
      transition: transform 0.2s;
    }
    
    .match-card:hover {
      transform: translateY(-2px);
      background: #232d42;
      border-left: 2px solid var(--rl-orange);
    }

    .match-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .team-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 4px;
      background: rgba(0,0,0,0.2);
    }

    .team-entry.winner {
      background: linear-gradient(90deg, rgba(0, 157, 255, 0.2), transparent);
      border-left: 2px solid var(--rl-blue);
    }

    .team-name { font-weight: 600; font-size: 0.9rem; }
    
    /* Series Pips (BO3) */
    .pip-row { display: flex; gap: 4px; }
    .pip {
      width: 8px; height: 8px;
      background: #334155;
      transform: skewX(-20deg);
    }
    .pip.won { background: var(--rl-blue); box-shadow: 0 0 8px var(--rl-blue); }

    /* --- GRAND FINAL CARD --- */
    .finals-card {
      background: linear-gradient(135deg, #1b2333 0%, #0f141f 100%);
      border: 1px solid var(--rl-orange);
      padding: 20px;
      clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
      text-align: center;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .final-label {
      color: var(--rl-orange);
      font-family: 'Share Tech Mono';
      letter-spacing: 2px;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .final-team {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 10px 0;
      text-transform: uppercase;
    }

    .final-team.tbd { color: var(--text-muted); font-size: 1.2rem; font-style: italic; }

    .vs-badge {
      font-size: 0.8rem;
      background: #333;
      color: #aaa;
      width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      margin: 10px auto;
    }

    /* BO5 Pips */
    .bo5-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
    }
    
    .bo5-row {
      display: flex;
      gap: 6px;
    }
    
    .pip-lg {
      width: 12px; height: 20px;
      background: #334155;
      transform: skewX(-20deg);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .pip-lg.won { background: var(--rl-orange); box-shadow: 0 0 10px var(--rl-orange); border-color: #fff; }

    .champ-section {
      margin-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 20px;
    }
    .champ-name {
      font-size: 2rem;
      color: var(--rl-blue);
      text-shadow: 0 0 20px rgba(0, 157, 255, 0.6);
      font-weight: 800;
    }

    #confetti-canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    }

  </style>
</head>
<body>

  <div class="bg-grid"></div>

  <div class="header-block">
    <div>
      <h1>Scholastic Rocket League</h1>
      <div class="sub-h1">ROUND ROBIN // BO3 GROUP · BO5 FINAL</div>
    </div>
    <div class="live-pill">
      <div class="pulse-dot"></div>
      <span id="sync-status">SYNCING...</span>
    </div>
  </div>

  <div class="dashboard-grid">
    
    <div class="panel">
      <div class="panel-title">Standings (Live)</div>
      <table class="standings-table">
        <thead>
          <tr>
            <th>Team</th>
            <th>W-L</th>
            <th>Diff</th>
          </tr>
        </thead>
        <tbody id="standings-body">
          </tbody>
      </table>
      <div style="font-size:0.75rem; color:#666; margin-top:auto;">
        Top 2 teams qualify for Grand Final. <br>Tiebreaker: Match Wins > Goal Diff.
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Group Stage (Best of 3)</div>
      <div class="matches-container" id="group-matches">
        </div>
    </div>

    <div class="panel">
      <div class="panel-title">Grand Final (Best of 5)</div>
      
      <div class="finals-card">
        <div class="final-label">CHAMPIONSHIP MATCH</div>
        
        <div class="final-team tbd" id="final-t1">Top Seed</div>
        <div class="bo5-container">
           <div class="bo5-row" id="final-pips-t1">
             <div class="pip-lg"></div><div class="pip-lg"></div><div class="pip-lg"></div>
           </div>
        </div>

        <div class="vs-badge">VS</div>

        <div class="final-team tbd" id="final-t2">2nd Seed</div>
        <div class="bo5-container">
           <div class="bo5-row" id="final-pips-t2">
             <div class="pip-lg"></div><div class="pip-lg"></div><div class="pip-lg"></div>
           </div>
        </div>

        <div class="champ-section">
          <canvas id="confetti-canvas"></canvas>
          <div style="font-size:0.8rem; color:#888; letter-spacing:2px;">WINNER</div>
          <div class="champ-name" id="champion-name">TBD</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- CONFIG ---
    // Use the backend URL provided in previous context
    const API_URL = 'https://script.google.com/macros/s/AKfycbxWWnjyvwawcKKf0wtVya6M8GQHdGM9gcgz48C6T0CzoZ8gFxbXyaSAt0vdx9fhv_G4IQ/exec';
    
    const teams = [
      { id: "T1", name: "Cassopolis" },
      { id: "T2", name: "Otsego" },
      { id: "T3", name: "Marcellus HS" },
      { id: "T4", name: "MI Lutheran" }
    ];

    const groupMatchesDef = [
      { id: "G1", t1: "T1", t2: "T2" },
      { id: "G2", t1: "T3", t2: "T4" },
      { id: "G3", t1: "T1", t2: "T3" },
      { id: "G4", t1: "T2", t2: "T4" },
      { id: "G5", t1: "T1", t2: "T4" },
      { id: "G6", t1: "T2", t2: "T3" }
    ];

    let prevChampion = "";

    // --- LOGIC: Compute Winner from Game Scores ---
    // Rocket League API returns Game 1 Score, Game 2 Score...
    // We must calc who won the SERIES (BO3)
    function calculateSeries(matchData, isBo5 = false) {
      let wins1 = 0;
      let wins2 = 0;
      let gamesPlayed = 0;
      let goalDiff1 = 0;
      
      const maxGames = isBo5 ? 5 : 3;

      for (let i = 1; i <= maxGames; i++) {
        // Data keys are roughly "matchId-game-team" based on how typical AppScript saves
        // But the previous API usually returns a structured object.
        // Assuming we get something like matches['G1'] = { game1_t1: 2, game1_t2: 1 ... }
        // Let's adapt based on the JSON structure the user typically has. 
        // We will assume the API returns an object where we can check games.
        
        // Actually, looking at previous prompt's logic, we need to handle the data object.
        // Let's assume the API returns: { G1: { t1: "A", t2: "B", scores: [ {g1t1: 2, g1t2: 1}, ... ] } }
        // Or simpler: { G1: { g1t1: 2, g1t2: 1, g2t1: 0, g2t2: 3 ... } }
        
        const s1 = parseInt(matchData[`g${i}t1`]);
        const s2 = parseInt(matchData[`g${i}t2`]);

        if (!isNaN(s1) && !isNaN(s2)) {
          gamesPlayed++;
          goalDiff1 += (s1 - s2);
          if (s1 > s2) wins1++;
          if (s2 > s1) wins2++;
        }
      }

      return {
        wins1, wins2, goalDiff1,
        winner: wins1 > wins2 ? 1 : (wins2 > wins1 ? 2 : 0)
      };
    }

    // --- RENDER FUNCTIONS ---

    function getPips(wins, max) {
      let html = '<div class="pip-row">';
      for(let i=0; i<max; i++) {
        html += `<div class="pip ${i < wins ? 'won' : ''}"></div>`;
      }
      html += '</div>';
      return html;
    }

    async function updateDashboard() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const matchesData = data.matches || {}; // Assuming flat map of MatchID -> ScoreData

        // 1. Process Group Stage & Standings
        const teamStats = {};
        teams.forEach(t => teamStats[t.id] = { ...t, wins:0, losses:0, gd:0 });

        const groupContainer = document.getElementById('group-matches');
        groupContainer.innerHTML = '';

        groupMatchesDef.forEach((m, idx) => {
          // Get calculated result
          const mData = matchesData[m.id] || {};
          const result = calculateSeries(mData, false); // BO3

          // Update Stats
          const seriesComplete = (result.wins1 >= 2 || result.wins2 >= 2);
          if(seriesComplete) {
            if(result.wins1 > result.wins2) {
              teamStats[m.t1].wins++;
              teamStats[m.t2].losses++;
            } else {
              teamStats[m.t2].wins++;
              teamStats[m.t1].losses++;
            }
            teamStats[m.t1].gd += result.goalDiff1;
            teamStats[m.t2].gd -= result.goalDiff1;
          }

          // Render Card
          const t1 = teams.find(t=>t.id===m.t1).name;
          const t2 = teams.find(t=>t.id===m.t2).name;

          const card = document.createElement('div');
          card.className = 'match-card';
          card.innerHTML = `
            <div class="match-meta">Match ${idx+1} (BO3)</div>
            <div class="team-entry ${result.wins1 > result.wins2 && seriesComplete ? 'winner' : ''}">
              <span class="team-name">${t1}</span>
              ${getPips(result.wins1, 2)}
            </div>
            <div class="team-entry ${result.wins2 > result.wins1 && seriesComplete ? 'winner' : ''}">
              <span class="team-name">${t2}</span>
              ${getPips(result.wins2, 2)}
            </div>
          `;
          groupContainer.appendChild(card);
        });

        // 2. Render Standings
        const sortedTeams = Object.values(teamStats).sort((a,b) => {
          if(b.wins !== a.wins) return b.wins - a.wins;
          return b.gd - a.gd; // GD tiebreaker
        });

        const standingsBody = document.getElementById('standings-body');
        standingsBody.innerHTML = '';
        sortedTeams.forEach((t, idx) => {
          const isQualified = idx < 2;
          const diffClass = t.gd > 0 ? 'pos' : (t.gd < 0 ? 'neg' : '');
          const diffPrefix = t.gd > 0 ? '+' : '';
          
          const row = `
            <tr class="standings-row ${isQualified ? 'qualified' : ''}">
              <td>${t.name} ${isQualified ? '<span style="font-size:0.7em; color:var(--rl-blue);">[Q]</span>' : ''}</td>
              <td class="stat-num">${t.wins} - ${t.losses}</td>
              <td class="stat-num stat-diff ${diffClass}">${diffPrefix}${t.gd}</td>
            </tr>
          `;
          standingsBody.innerHTML += row;
        });

        // 3. Render Grand Final
        const finalsData = matchesData['FINAL'] || {}; // Assuming backend uses 'FINAL' or we map inputs to it
        // We actually need to map the games 1-5 inputs to this. 
        // Let's assume the user enters data for "M_FINAL" or similar in backend.
        // For now, let's use the sortedTeams to populate Names if match hasn't started,
        // or check if specific final ID exists.
        
        // Populate Top 2 Names
        const finalT1 = document.getElementById('final-t1');
        const finalT2 = document.getElementById('final-t2');
        
        if(sortedTeams[0].wins + sortedTeams[0].losses > 0) {
          finalT1.innerText = sortedTeams[0].name;
          finalT1.classList.remove('tbd');
          finalT2.innerText = sortedTeams[1].name;
          finalT2.classList.remove('tbd');
        }

        // Logic for Final BO5 Score
        // We look for finals data. In the previous provided code, it used data attributes.
        // We will assume matchesData contains keys 'F_g1t1', 'F_g1t2' etc.
        let fWins1 = 0; 
        let fWins2 = 0;
        
        // Check 5 games
        for(let i=1; i<=5; i++) {
           let s1 = parseInt(matchesData[`final_g${i}t1`]); // Adjusted to hypothetical key
           let s2 = parseInt(matchesData[`final_g${i}t2`]);
           if(!isNaN(s1) && !isNaN(s2)) {
             if(s1 > s2) fWins1++;
             if(s2 > s1) fWins2++;
           }
        }

        // Update Pips BO5
        const pipsT1 = document.getElementById('final-pips-t1').children;
        const pipsT2 = document.getElementById('final-pips-t2').children;
        
        // Fill 3 slots (first to 3)
        for(let i=0; i<3; i++) {
          pipsT1[i].className = `pip-lg ${i < fWins1 ? 'won' : ''}`;
          pipsT2[i].className = `pip-lg ${i < fWins2 ? 'won' : ''}`;
        }

        // Champion Check
        const champEl = document.getElementById('champion-name');
        let currentChamp = "TBD";
        if(fWins1 >= 3) currentChamp = sortedTeams[0].name;
        if(fWins2 >= 3) currentChamp = sortedTeams[1].name;

        champEl.innerText = currentChamp;
        
        if(currentChamp !== "TBD" && currentChamp !== prevChampion) {
          prevChampion = currentChamp;
          startConfetti();
        }

        document.getElementById('sync-status').innerText = "LIVE";
        document.getElementById('sync-status').style.color = "var(--rl-blue)";

      } catch (e) {
        console.log("Polling...", e);
      }
    }

    // --- CONFETTI FX ---
    function startConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.parentElement.offsetWidth;
      canvas.height = canvas.parentElement.offsetHeight;
      
      let particles = [];
      for(let i=0; i<60; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          speed: Math.random() * 4 + 2,
          color: Math.random() > 0.5 ? '#009dff' : '#ff8d00',
          size: Math.random() * 5 + 2
        });
      }

      function animate() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach(p => {
          p.y += p.speed;
          if(p.y > canvas.height) p.y = -10;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.size, p.size);
        });
        requestAnimationFrame(animate);
      }
      animate();
    }

    // Init
    updateDashboard();
    setInterval(updateDashboard, 5000); // Poll every 5s

  </script>
</body>
</html>
